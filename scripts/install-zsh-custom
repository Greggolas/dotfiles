#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="$(cd "$(dirname "$0")/.." && pwd)"
SRC="$REPO_DIR/zsh/custom/dotfiles.zsh"

if [ ! -f "$SRC" ]; then
  echo "Missing anchor file: $SRC" >&2
  exit 1
fi

# Resolution order:
# 1) DOTFILES_ZSH_CUSTOM explicitly provided by caller
# 2) ZSH_CUSTOM from a zsh process WITHOUT rc files
# 3) default OMZ custom dir
ZSH_CUSTOM="${DOTFILES_ZSH_CUSTOM:-}"

if [ -z "${ZSH_CUSTOM:-}" ] && command -v zsh >/dev/null 2>&1; then
  # -f: don't load any startup files. This avoids relying on a working ~/.zshrc.
  ZSH_CUSTOM="$(zsh -fc 'print -r -- ${ZSH_CUSTOM:-}' 2>/dev/null || true)"
fi

if [ -z "${ZSH_CUSTOM:-}" ]; then
  ZSH_CUSTOM="$HOME/.oh-my-zsh/custom"
fi

mkdir -p "$ZSH_CUSTOM"

BACKUP="$HOME/.dotfiles-backup/$(date +%Y%m%d-%H%M%S)/zsh-custom"
mkdir -p "$BACKUP"

DST="$ZSH_CUSTOM/dotfiles.zsh"

# If already correct, do nothing.
if [ -L "$DST" ] && [ "$(readlink "$DST")" = "$SRC" ]; then
  echo "already linked: $DST"
  echo "ZSH_CUSTOM=$ZSH_CUSTOM"
  exit 0
fi

# Backup existing destination (file or symlink)
if [ -e "$DST" ] || [ -L "$DST" ]; then
  mv "$DST" "$BACKUP/$(basename "$DST")"
fi

ln -s "$SRC" "$DST"
echo "linked $DST -> $SRC"
echo "ZSH_CUSTOM=$ZSH_CUSTOM"
echo "Backups (if any): $BACKUP"
